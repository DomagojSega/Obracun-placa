<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" 
    crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" 
    rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" 
    crossorigin="anonymous">
    <link rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="src/users.js"></script>
    <script src="src/obracuni.js"></script>
    <script src="src/stope.js"></script>
    <script src="src/obavijesti.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Obracun placa</title>
    <script>
        const handleLogout = () => {
            sessionStorage.removeItem("userIndex");
            window.location.href="login.html";
        }
        
        

    </script>
</head>
<body>
    <div class="container-fluid" style="background-color:#EFEFEF">
        <div class="row" style="height:100vh; padding-top:100px;">
            <div class="col-3" style="border-right: 1px solid #7E7E7E; height:calc(100vh - 100px);">
                <div class="row me-3 pb-5" style="border-bottom: 1px solid #7E7E7E;  padding-left:10%; flex-wrap:wrap;">
                    <div class="col-6 text-center">
                        <img style="width:92px; height:88px; border-radius:20px;" src="img/no-user-image.jpg" alt="Slika korisnika">
                    </div>
                    <div  class="col-6" style="align-self:center;">
                        <div id="userFullName" class="black-bold" style="font-size:22px;"></div>
                        <a href="settings.html" style="font-size:16px;">UREDI PROFIL</a>  
                    </div>
                </div>
                <div class="mt-5" style="display:flex; flex-direction: column; height:65%; justify-content:space-between; padding-top:10%; padding-left:100px;">
                    <nav class="nav-text">
                        <ul style="list-style:none; padding-left:0; justify-self:flex-start;">
                            <li class="extrabold" style="color:#343857; font-size:16px;">INFO</li>
                            <li><a href="userdashboard.html">
                                <span class="fa-solid fa-chart-line" style="color:#343857;"></span> 
                                &nbsp&nbsp Nadzorna ploča</a></li>
                            <li><a href="obavijesti.html">
                                <span class="fa-solid fa-bell" style="color:#343857;"></span>
                                &nbsp&nbsp Obavijesti</a></li>
                            <li><a href="" class="nav-active">
                                <span class="fa-solid fa-user" style="color:#343857;"></span>
                                &nbsp&nbsp Podaci o korisniku</a></li>
                            <li><a href="settings.html">
                                <span class="fa-solid fa-gear" style="color:#343857;"></span> 
                                &nbsp&nbsp Postavke</a></li>
                        </ul>
                    </nav>
                    <div class="nav-text" style="justify-self: flex-end;">
                        <a href="javascript:handleLogout()"> 
                            <span class="fa-solid fa-right-from-bracket" style="color:#343857;"></span>
                            &nbsp&nbsp Odjava</a>
                    </div>
                </div>
            </div>
            <div class="col-3 ps-5">
                <div class="row"><span class="fa-solid fa-user" style="color:#343857; font-size:38px;"></span></div>
                <div class="row nav-active" style="font-size:37px; padding:12px;">Podaci o korisniku</div>

                
                    <div class="mt-4">
                        <label for="userFirstName" class="label-text" style="font-size:12px;">Ime</label>
                        <div class="input-group">
                            <input type="text" name="userFirstName" class="form-control body-text" 
                            id="userFirstName" disabled>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="userLastName" class="label-text" style="font-size:12px;">Prezime</label>
                        <div class="input-group">
                            <input type="text" name="userLastName" class="form-control body-text" 
                            id="userLastName" disabled>
                        </div>
                    </div>
                
                    
                        <div class="mt-4">
                            <label for="userOIB" class="label-text" style="font-size:12px;">OIB</label>
                            <div class="input-group">
                                <input type="text" name="userOIB" class="form-control body-text" 
                                id="userOIB" disabled>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label for="userName" class="label-text" style="font-size:12px;">Korisničko ime</label>
                            <div class="input-group">
                                <input type="text" name="userName" class="form-control body-text" 
                                id="userName" disabled>
                            </div>
                        </div>
                    
                <div class="row mt-4">
                    <div class="col-6">
                        <label for="userHour" class="label-text" style="font-size:12px;">Satnica</label>
                        <div class="input-group">
                            <input type="text" name="userHour" class="form-control body-text" 
                            id="userHour" disabled>
                            <div class="input-group-prepend">
                                <div class="input-group-text">€</div>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <label for="netoPlaca" class="label-text" style="font-size:12px;">Neto plaća</label>
                        <div class="input-group">
                            <input type="text" name="netoPlaca" class="form-control body-text" 
                            id="netoPlaca" disabled>
                            <div class="input-group-prepend">
                                <div class="input-group-text">€</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class=" mt-5 text-center">
                    <a href="#" class="btn btn-primary btn-lg" 
                        style="background-color:#525798; border-color:#525798;"
                            >Zatraži promjene</a>
                </div>
            </div>
            <div class="col-6 mt-5" >
                <div class="row mt-5">
                    <div class="card chart-container">
                        <canvas id="chart"></canvas>
                    </div>
                </div>
                
                <div class="row mt-5">
                    <div class="col-2"></div>
                    <div class="col-8 body-text text-center" id="userPaycheckTable">
                    </div>
                    <div class="row body-text text-center"><p>Pregled zadnje obračunatih plaća</p></div>
                </div>
            </div>
        </div>
    </div>
</div>
    <script>
        let obracuniUpdated=JSON.parse(sessionStorage.getItem("obracuniUpdated"));
        let stopeUpdated=JSON.parse(sessionStorage.getItem("stopeUpdated"));
        let usersUpdated=JSON.parse(sessionStorage.getItem("usersUpdated"));
        let obavijestiUpdated=JSON.parse(sessionStorage.getItem("obavijestiUpdated"));
        const mjeseci = ["Siječanj","Veljača","Ožujak","Travanj","Svibanj","Lipanj","Srpanj","Kolovoz","Rujan","Listopad","Studeni","Prosinac"];
        const godine = [2022,2023];
        let userIndex = parseInt(sessionStorage.getItem("userIndex"));
        let userPaychecks = [...obracuniUpdated.filter(obr => userIndex+1 == obr.userid )];
        let userPaychecksMonthsSorted = [,1200,1300,1100,900,750,,1000,1100,1000,1300,1200];

        window.onload = () => {
            let userFullName = document.getElementById("userFullName");
            let firstname = usersUpdated[userIndex]["firstname"];
            let lastname = usersUpdated[userIndex]["lastname"];
            userFullName.innerText=firstname + " " + lastname;

            

            if(!obracuniUpdated){
                sessionStorage.setItem("obracuniUpdated", JSON.stringify(obracuni));
                obracuniUpdated=JSON.parse(sessionStorage.getItem("obracuniUpdated"));
            }
            if(!stopeUpdated){
                sessionStorage.setItem("stopeUpdated", JSON.stringify(stope));
                stopeUpdated=JSON.parse(sessionStorage.getItem("stopeUpdated"));
            }
            if(!usersUpdated){
                sessionStorage.setItem("usersUpdated", JSON.stringify(users));
                usersUpdated=JSON.parse(sessionStorage.getItem("usersUpdated"));
            }
            if(!obavijestiUpdated){
                sessionStorage.setItem("obavijestiUpdated", JSON.stringify(obavijesti));
                obavijestiUpdated=JSON.parse(sessionStorage.getItem("obavijestiUpdated"));
            }

            let userSatnica = parseInt(usersUpdated[userIndex]["satnica"]);
            let ukupnoSati = parseInt(stopeUpdated[0]["ukupnoSati"]);
            let faktorPrekRad = parseFloat(stopeUpdated[0]["prekRad"]);
            let faktorGodOdmor = parseFloat(stopeUpdated[0]["godOdmor"]);
            let faktorBolovanje = parseFloat(stopeUpdated[0]["bolovanje"]);
            let mirovinskiStup = parseFloat(stopeUpdated[0]["mirovinskiStup"]);
            let porezStopa = parseFloat(stopeUpdated[0]["porez"]);
            let calcBruto = userSatnica * ukupnoSati;
            let calcNeto = (calcBruto * (100-mirovinskiStup)/100) * (100 - porezStopa)/100;

            let userFirstName = document.getElementById("userFirstName");
            let userLastName = document.getElementById("userLastName");
            let userOIB = document.getElementById("userOIB");
            let userName = document.getElementById("userName");
            let userHour = document.getElementById("userHour");
            let netoPlaca = document.getElementById("netoPlaca");

            userFirstName.value=firstname;
            userLastName.value=lastname;
            userOIB.value=usersUpdated[userIndex]["oib"];
            userName.value=usersUpdated[userIndex]["username"];
            userHour.value=usersUpdated[userIndex]["satnica"];
            userName.value=usersUpdated[userIndex]["username"];
            netoPlaca.value=calcNeto;
            

            let userPaycheckTable = document.getElementById("userPaycheckTable");
            let pl = userPaychecks.length;
            if(pl > 0){
                let userTable = `<table class="table table-striped table-hover">
                                    <thead><tr><th>Godina</th><th>Mjesec</th><th>Neto plaća</th><th>PDF</th></tr></thead>`;
                for (let i = 1; i <= pl; i++){
                    userTable += `<tr>
                                    <td>${userPaychecks[pl-i]["godina"]}</td>
                                    <td>${userPaychecks[pl-i]["mjesec"]}</td>
                                    <td>${userPaychecks[pl-i]["neto"]} €</td>
                                    <td><p class="body-text">Preuzmi <span class="fa-solid fa-download"></span></p></td>
                                </tr>`;
                    if(i==5){
                        break;
                    }
                }
                userTable += `</table>`;
                userPaycheckTable.innerHTML = userTable;
            }
            
        }

        

        //line chart
        const ctx = document.getElementById("chart").getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
            labels: mjeseci,
            datasets: [{
                label: '2022',
                data: userPaychecksMonthsSorted,
                fill: false,
                borderColor: '#5B6BBF63',
                backgroundColor: '#5B6BBF63'
            }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            },
        });
        

    

    </script>
</body>
</html>